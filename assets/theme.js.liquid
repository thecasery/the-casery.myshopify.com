/* Simple jQuery Equal Heights @version 1.5.1. Copyright (c) 2013 Matt Banks. Dual licensed under the MIT and GPL licenses. */
!function(a){a.fn.equalHeights=function(){var b=0,c=a(this);return c.each(function(){var c=a(this).innerHeight();c>b&&(b=c)}),c.css("height",b)},a("[data-equal]").each(function(){var b=a(this),c=b.data("equal");b.find(c).equalHeights()})}(jQuery);

/* Run function after window resize */
var afterResize=(function(){var t={};return function(callback,ms,uniqueId){if(!uniqueId){uniqueId="Don't call this twice without a uniqueId";}if(t[uniqueId]){clearTimeout(t[uniqueId]);}t[uniqueId]=setTimeout(callback,ms);};})();

window.theme = window.theme || {};

// Facebook api
window.fbAsyncInit = function() {
  FB.init({
    appId      : '1516749411980352',
    xfbml      : true,
    version    : 'v2.5'
  });
};

(function(d, s, id){
  var js, fjs = d.getElementsByTagName(s)[0];
  if (d.getElementById(id)) {return;}
  js = d.createElement(s); js.id = id;
  js.src = "//connect.facebook.net/en_US/sdk.js";
  fjs.parentNode.insertBefore(js, fjs);
}(document, 'script', 'facebook-jssdk'));

theme.cacheSelectors = function () {
  theme.cache = {
    // General
    $w: $(window),
    $body: $('body'),

    // Mobile Nav
    $mobileNavTrigger: $('#MobileNavTrigger'),
    $mobileNav: $('#MobileNav'),
    $mobileSublistTrigger: $('.mobile-nav__sublist-trigger'),

    // Equal height elements
    $productGridImages: $('.grid-link__image--product'),
    $featuredGridImages: $('.grid-link__image--collection'),
    
    // Product page
    $productImage: $('#ProductPhotoImg'),
    $productImageGallery: $('.gallery__item'),

    // Cart Page
    cartNoteAdd: '.cart__note-add',
    cartNote: '.cart__note'
  }
};

theme.init = function () {
  theme.cacheSelectors();
  theme.mobileNav();
  theme.equalHeights();
  theme.cartPage();
};

theme.mobileNav = function () {
  theme.cache.$mobileNavTrigger.on('click', function() {
    theme.cache.$mobileNav.slideToggle(220);
  });

  theme.cache.$mobileSublistTrigger.on('click', function(evt) {
    var $el = $(this);

    // Enable commented out if statement to allow direct clicking on trigger link
    // if (!$el.hasClass('is-active')) {
      evt.preventDefault();
      $el.toggleClass('is-active').next('.mobile-nav__sublist').slideToggle(200);
    // }
  });
};

theme.equalHeights = function () {
  theme.cache.$w.on('load', resizeElements());

  theme.cache.$w.on('resize',
    afterResize(function() {
      resizeElements();
    }, 250, 'equal-heights')
  );

  function resizeElements() {
    theme.cache.$productGridImages.css('height', 'auto').equalHeights();
    theme.cache.$featuredGridImages.css('height', 'auto').equalHeights();
  }
};

theme.cartPage = function () {
  {% unless settings.cart_notes_enable %}
    return;
  {% endunless %}

  theme.cache.$body.on('click', theme.cache.cartNoteAdd, function () {
    $(this).addClass('is-hidden');
    $(theme.cache.cartNote).addClass('is-active');
    ajaxifyShopify.sizeDrawer();
  });
};

// Initialize theme's JS on docready
$(theme.init);

/* Belowing is implemented by Yang Wang @thecasery.Inc 2015 */

/* The autoscale element function is used for adjusting picture size and location according to screen size.
 * The container size is set to current screen size.
 * The inside element size is set to 2:1. if it's largger than 2:1, we cut some of the width;
 *   if it's smaller than 2:1, we cut some of the height.
 * 
 * To realize this function, don't forget to set container "overflow:hidden", and use margin to set element position.
 */
var autoscale_element = function(){ 
  // At this point, pic_width & height are screen size, used to set div size.
  var picture_height = document.documentElement.clientHeight-30;
  $('.autoscale__div').css("height", picture_height);
  $('.autoscale__div').css("width", '100%');
  var picture_width = $('.autoscale__div').width();

  // Adjust picture width:height to 2:1
  if (picture_height < 600 && picture_width < 1200) {
    picture_height = 600;
    picture_width = 1200;
  } else if (picture_height * 2 < picture_width) {
    picture_height = picture_width / 2;
  } else {
    picture_width = picture_height * 2;
  }

  // calculate margin to adjust picture position, make it at center.
  var margin_top = (document.documentElement.clientHeight - 50 - picture_height) / 2;
  var margin_left = ($('.autoscale__div').width() - picture_width) / 2;

  $(".autoscale__elem").css("height", picture_height);
  $(".autoscale__elem").css("width", picture_width);

  $(".autoscale__elem").css("margin-left", margin_left);
  $(".autoscale__elem").css("margin-top", margin_top);

  // This is a side function, just to adjust slider's navigation-bar position
  $(".slider-nav").css("top", $('.slide-img').height() - 70);
  $(".slider-nav").css("left", ($('.slide-img').width()-200) / 2);

  // Also here's width of inpage-cart to be whole page
  if ($('.active-cart').hasClass('active-cart')){
    $('.active-cart').css("width", document.documentElement.clientWidth);
    $('.active-cart').css("margin-left", 0 - $('.active-product').offset().left - 10);
  }
};

if ((typeof Shopify) == 'undefined') {
  var Shopify = {};
}

/* This is version 2.0 of Inpage shopping cart
 *
 * The basic strategy is hidding the detail information of the product, and only display it when click the image.
 * Node that most important part is the css. Actually, '.grid__product' are at the same line with same height.
 * But display '.inpage-cart' could make one element pretty high, and the width of 'inpage-cart' could be larger than its parent.
 * So the effects is that '.inpage-cart' takes a whole line. But actually its in the same line with other 'grid__product'
 * 
 * BTW: There're several 'active-' classes that helping us locating current working elements.
 * 'active-product' is current 'grid_product', 'active-'
 */

// Social Media Change: '.back-img' is the share img, 'h1' is product title, '.active-option1' is phone style name
function change_social_media(product){
  // Facebook
  product.find('#facebook').attr("href","https://www.facebook.com/dialog/feed?app_id=1516749411980352&display=page&caption=Welcome%20to%20the%20casery&picture=http:"+product.find('.back-img').attr("src")+"&name="+product.find('h1').text()+"&description="+product.find('.active-option1').attr("name")+"&link=http://the-casery.myshopify.com/collections/all&redirect_uri="+window.location.href+"");
  // Pinterest
  product.find('#pinterest').attr("href","https://pinterest.com/pin/create/button/?url=http://the-casery.myshopify.com/collections/all&amp;media=http:"+product.find('.back-img').attr("src")+"&amp;description="+product.find('h1').text()+" ("+product.find('.active-option1').attr("name")+")");
  // Twitter
  product.find('#twitter').attr("href","https://twitter.com/share?url=http:"+product.find('.back-img').attr("src")+"&amp;text=The Casery - "+product.find('h1').text()+" ("+product.find('.active-option1').attr("name")+")");
  // Tumblr
  product.find('#tumblr').attr("href","https://www.tumblr.com/widgets/share/tool?posttype=photo&content="+product.find('.back-img').attr("src")+"&caption="+product.find('h1').text()+" ("+product.find('.active-option1').attr("name")+")&canonicalUrl=http://the-casery.myshopify.com/collections/all");
}


// initial option3 value, which is picture
function init_option3(product, start_pos, total_options, variants){
  // remove previous image
  $('.active-option3').removeClass("active-option3");
  product.find('#option3 li').remove();

  var arr3 = new Array();
  for (var i = start_pos; i < total_options && variants[i][0] == variants[start_pos][0] && variants[i][1] == variants[start_pos][1] && variants[i][2] == variants[start_pos][2]; i++){
    var flag3 = true;
    for (var j = 0; j < arr3.length; j++){
      if (arr3[j] == variants[i][3]){
        flag3 = false;
        break;
      }
    }
    if (flag3){
      arr3.push(variants[i][3]);
      product.find('#option3').append("<li class='grid__item thumbnail-img'><img style='display:inline-block; width:100px;' src='"+variants[i][4]+"' /></li>");
    }
  }

  // reset '.back-img', '.active-option3', reset social media
  product.find('#option3 img').first().addClass("active-option3");
  product.find('.back-img').attr("src", $('.active-option3').attr("src"));
  change_social_media(product);
}

// initial option2 value, which is phone type
function init_option2(product, start_pos, total_options, variants){
  product.find('#option2 option').remove();
  var arr2 = new Array();
  for (var i = start_pos; i < total_options && variants[i][0] == variants[start_pos][0] && variants[i][1] == variants[start_pos][1]; i++){
    var flag2 = true;
    for (var j = 0; j < arr2.length; j++){
      if (arr2[j] == variants[i][2]){
        flag2 = false;
        break;
      }
    }
    if (flag2){
      arr2.push(variants[i][2]);
      product.find('#option2').append("<option value='"+i+"'>"+variants[i][2]+"</option>");
    }
  }

  // reset start_pos for init_option3, reset selectIndex for hidden select & option2 select
  product.find('#productSelect').get(0).selectedIndex = start_pos;
  product.find('#option2').get(0).selectedIndex = 0; 
  init_option3(product, start_pos, total_options, variants);
}

// initial option1 value, which is phone style
function init_option1(product, start_pos, total_options, variants){
  // remove previous image
  $('.active-option1').removeClass('active-option1');
  product.find('#option1 img').remove();

  var arr1 = new Array();
  for (var i = start_pos; i < total_options && variants[i][0] == variants[start_pos][0]; i++){
    var flag1 = true;
    for (var j = 0; j < arr1.length; j++){
      if (arr1[j] == variants[i][1]){
        flag1 = false;
        break;
      }
    }
    if (flag1){
      arr1.push(variants[i][1]);
      product.find('#option1').append("<img name='"+variants[i][1]+"' src='"+variants[i][4]+"' onmouseover=\"this.style.cursor='hand'\"/>");
    }
  }

  // reset start_pos for init_option2
  product.find('#option1 img').first().addClass('active-option1');
  init_option2(product, start_pos, total_options, variants);
}

// initialize all the variants!!
function init_variants(product){
  var productSelect = product.find('#productSelect');
  var product_options = productSelect.find('option');
  var total_options = product_options.length;
  var variants = new Array();
  var casetype = false;

  // string split, I use ' @ ' to seperate different options
  for (var i = 0; i < total_options; i++){
    var string = product_options.eq(i).text();
    var t = string.split(' @ ');
    // if there's casetype, then we need to split the first option1 string
    if (t[1].indexOf(' - ') >= 0){
      var temp = t[1].split(' - ');
      t[0] = temp[1];
      t[1] = temp[0];
      casetype = true;
    } else {
      t[0] = 'NONE';
    }
    variants.push(t);
  }
  // if there's casetype, we need to enable button
  if (casetype){
    product.find('#option0').css('display','block');
  } else {
    product.find('#option0').css('display','none');
  }

  // reset start_pos for init_option1
  product.find('#option0 span').first().addClass('active-option0');
  init_option1(product, 0, total_options, variants);
}


/* Part 2 : Updating */
// update option0
function change_option0(self, total_options, variants){
  var product = self.parents('.inpage-cart');
  var id = self.attr('id');

  $('.active-option0').removeClass('active-option0');
  self.addClass('active-option0');
  if (id.indexOf('Snap') >= 0){
    init_option1(product, 0, total_options, variants);
  }
  else{
    var i = 0;
    for (; i < total_options && variants[i][0].indexOf('Tough') < 0; i++);
    init_option1(product, i, total_options, variants);
  }
}

// update option1
function change_option1(self, total_options, variants){
    var product = self.parents('.inpage-cart');
    // remove all active-image class which highlight the border, and we need to remove previous
    $('.active-option1').removeClass('active-option1');
    self.addClass('active-option1');

    // After pre-set, find the first index that have the same picture url, that is the start of variant.option1
    var new_option1_name = self.attr("name");
    var current_index = product.find('#productSelect').get(0).selectedIndex;

    var new_index = 0;
    for (; new_index < total_options && variants[new_index][0] != variants[current_index][0]; new_index ++);
    for (; new_index < total_options && variants[new_index][0] == variants[current_index][0] && variants[new_index][1] != new_option1_name; new_index++);

    // initial option2
    init_option2(product, new_index, total_options, variants);
}

// update option2
function change_option2(self, total_options, variants){
  var product = self.parents('.inpage-cart');
  // find new index
  var new_index = product.find('#option2').val();
  product.find('#productSelect').get(0).selectedIndex = new_index;

  // initial option3
  init_option3(product, new_index, total_options, variants);
}

// update option3
function change_option3(self, total_options, variants){
  var product = self.parents('.inpage-cart');
  
  product.find('.back-img').attr("src",self.attr("src"));
  $('.active-option3').removeClass("active-option3");
  self.addClass("active-option3");

  // social media
  change_social_media(product);
}

/* Try not to use $(this) or other things, only use the parameter in this function */
function product_click(cart){
  var productSelect = cart.find('#productSelect');
  var product_options = productSelect.find('option');
  var total_options = product_options.length;
  var variants = new Array();
  var casetype = false;

  // string split, I use ' @ ' to seperate different options
  for (var i = 0; i < total_options; i++){
    var string = product_options.eq(i).text();
    var t = string.split(' @ ');
    // if there's casetype, then we need to split the first option1 string
    if (t[1].indexOf(' - ') >= 0){
      var temp = t[1].split(' - ');
      t[0] = temp[1];
      t[1] = temp[0];
      casetype = true;
    } else {
      t[0] = 'NONE';
    }
    variants.push(t);
  }

  /* change value of option 0 */
  cart.find('#option0').off('click','span').on('click', 'span', function(){
    change_option0($(this), total_options, variants);
  });

  /* change value of option 1 */
  cart.find('#option1').off('click','img').on('click', 'img', function(){
    change_option1($(this), total_options, variants);
  });

  /* change value of option2 */
  // don't forget to off everything before register new event, to avoid multiple calls
  cart.find('#option2').unbind('change').change(function(){
    change_option2($(this), total_options, variants);
  });

  /* change value of option3 */
  //This is easy, just image change. But note that JQuery 1.7+ use 'on' method to replace bind, delegate, etc.
  cart.find('#option3').off('click','img').on('click','img',function(){
    change_option3($(this), total_options, variants);
  });

  /* Small change on slide-down cart alignment */
  cart.css("width", document.documentElement.clientWidth);
  cart.css("margin-left", 0 - $(this).offset().left - 10);
}


/* This is the main function of shopping cart */
var shopping_cart = function(){
  /* Here's main part of animation
   * Besides regular slideUp & Down, we need to check if current product posistion vs. previous product
   * if ==, just change content, no animation
   * if <>, the screen should animate accordingly
   * BTW, current_activate is used to determine whether a new cart should be slide down;
   * different_product is used to detect whether two product are the same
  */
  // When user clicking close button at top-right of slide-down cart
  $('.grid__product').off('click','.inpage-cart__close').on('click','.inpage-cart__close',function(){
    $('.active-product').find('.arrow-up').animate({opacity : 0}, 'middle');
    $('.active-cart').removeClass('active-cart').slideUp('middle');
    $("html, body").animate({ scrollTop: $('.active-product').offset().top - 80 }, 'middle');
    $('.active-product').removeClass('active-product');
  });

  $('.grid__product').off('click','.grid-link__image-centered').on('click','.grid-link__image-centered',function(){
    var current_activate, different_product = false;
    var prev_pos;
    if ($(this).parents('.grid__product').hasClass('active-product')){
      current_activate = false;
    }
    else{
      current_activate = true;
      if ($('.active-product').hasClass('active-product')){
        prev_pos = $('.active-product').offset().top;
        different_product = true;
      } else {
        prev_pos = $(this).parents('.grid__product').offset().top;
      }
    }

    // slide up previous cart
    $('.active-product').find('.arrow-up').animate({opacity : 0}, 'middle');
    $('.active-product').removeClass('active-product');
    if (different_product && prev_pos == $(this).parents('.grid__product').offset().top){
      $('.active-cart').removeClass('active-cart').css('display','none');
    } else {
      $('.active-cart').removeClass('active-cart').slideUp('middle');
    }

    // slide down new cart
    if (current_activate){
      $(this).parents('.grid__product').find('.arrow-up').animate({opacity : 1}, 'middle');
      $(this).parents('.grid__product').addClass('active-product');
      if (different_product && prev_pos == $(this).parents('.grid__product').offset().top){
        $(this).parents('.grid__product').find('.inpage-cart').addClass('active-cart').css('display','block');
      } else {
        $(this).parents('.grid__product').find('.inpage-cart').addClass('active-cart').slideDown("middle");
      }
      // screen scroll
      $('.active-cart').css("width", document.documentElement.clientWidth);
      $('.active-cart').css("margin-left", 0 - $('.active-product').offset().left - 10);
      if (prev_pos == $('.active-product').offset().top){
        $("html, body").animate({ scrollTop: prev_pos - 80 }, 0);
      } else if (prev_pos < $('.active-product').offset().top){
        $("html, body").animate({ scrollTop: prev_pos + 280}, "middle");
      } else {
        $("html, body").animate({ scrollTop: $('.active-product').offset().top - 80}, "middle");
      }
      var cart = $(this).parents('.grid__product').find('.inpage-cart');
      init_variants(cart);
      product_click(cart);
    }
  });

  // When user hovering product, change picture
  $('.grid__product').hover(function(){
    $(this).find('.product-img').css('display','none');
    $(this).find('.product-img__second').css('display','block');
  }, function(){
    $(this).find('.product-img__second').css('display','none');
    $(this).find('.product-img').css('display','block');
  });
}

/* artist_page animation*/
// There might be some bugs
var artist_page = function(){
  $('.artist-works').off('click','.grid-link__image-centered').on('click','.grid-link__image-centered',function(){
    var product = $(this).parents('.artist-works');
    var cart = product.find('.inpage-cart');
    var has_prev_product = false;
    var pos_prev_product;

    if ($('.active-cart').hasClass('active-cart') && !product.hasClass('active-product')){
      var prev_product = $('.active-product');
      has_prev_product = true;
      pos_prev_product = $('.active-product').offset().top;

      $('.active-product').removeClass('active-product');

      if (pos_prev_product == product.offset().top){
        $('.active-cart').removeClass('active-cart').css('display','none').insertAfter(prev_product.find('.arrow-up'));
      } else {
        $('.active-cart').removeClass('active-cart').slideUp('middle',function(){
          $(this).insertAfter(prev_product.find('.arrow-up'));  
        });
      }
    }

    if (product.hasClass('active-product')){
      var prev_product = $('.active-product');
      $('.active-product').removeClass('active-product');
      $('.active-cart').removeClass('active-cart').slideUp('middle',function(){
        $(this).insertAfter(prev_product.find('.arrow-up'));   
      });
    } else {
      product.addClass('active-product');
      if (has_prev_product && pos_prev_product == product.offset().top){
        cart.insertAfter(product.parents('.container')).addClass('active-cart').css('display','block');
      } else {
        cart.insertAfter(product.parents('.container')).addClass('active-cart').slideDown('middle');
        $("html, body").animate({ scrollTop: product.offset().top - 80 }, "middle");
      }

      init_variants(cart);
      product_click(cart);

      cart.off('click','.inpage-cart__close').on('click','.inpage-cart__close',function(){
        var prev_product = $('.active-product');
        $('.active-product').removeClass('active-product');
        $('.active-cart').removeClass('active-cart').slideUp('middle',function(){
          $(this).insertAfter(prev_product.find('.arrow-up'));   
        });
      });
    }
  });
}

// slider
var next_pic = function(){
  $('.slide-img').stop(true, true);
  var currentSlide = $('.active-img'),
      currentDot = $('.active-dot'),
      nextDot = currentDot.next();
      nextSlide = currentSlide.next();
  if (nextDot.length == 0){
      nextSlide = $('.slide-img').first();
      nextDot = $('.dot').first();
  }
  
  // animation: The front_slide is crutial, fix the position of the small number picture.
  // Otherwise, the small element cannot on top of large number element.
  var front_slide = (currentSlide.index() < nextSlide.index()) ? (currentSlide) : (nextSlide);
  front_slide.css("position", "absolute");

  nextSlide.addClass('active-img').fadeIn("slow", function(){
      currentSlide.removeClass('active-img').css("display","none");
      front_slide.css("position","static");
  });
  
  currentDot.removeClass('active-dot');
  nextDot.addClass('active-dot');
}

var prev_pic = function(){
  $('.slide-img').stop(true, true);
  var currentSlide = $('.active-img'),
      currentDot = $('.active-dot'),
      prevDot = currentDot.prev();
      prevSlide = currentSlide.prev();
  if (prevDot.length == 0){
      prevSlide = $('.slide-img').last();
      prevDot = $('.dot').last();
  }
  
  //animation
  var front_slide = (currentSlide.index() < prevSlide.index()) ? (currentSlide) : (prevSlide);
  front_slide.css("position", "absolute");
  prevSlide.addClass('active-img').fadeIn("slow", function(){
    currentSlide.removeClass('active-img').css("display","none");
    front_slide.css("position","static");
  });
  
  currentDot.removeClass('active-dot');
  prevDot.addClass('active-dot');
}

// click on dot to change pictures
var change_pic = function(){
  $('.slide-img').stop(true, true);
  var currentSlide = $('.active-img'),
      currentDot = $('.active-dot'),
      nextDot = currentDot,
      nextSlide = currentSlide;

  if ($(this).hasClass('active-dot')) return;

  // index technique, very important
  var index = $(this).index();
  nextDot = $('.dot').eq(index);
  nextSlide = $('.slide-img').eq(index);

  //animation
  var front_slide = (currentSlide.index() < nextSlide.index()) ? (currentSlide) : (nextSlide);
  front_slide.css("position", "absolute");
  nextSlide.addClass('active-img').fadeIn("slow", function(){
    currentSlide.removeClass('active-img').css("display","none");
    front_slide.css("position","static");
  });
  
  currentDot.removeClass('active-dot');
  nextDot.addClass('active-dot');
}

var carousel_setting = function(){
  // Try to make the navigation bar in the bottom-center of the screen.
  $(".slider-nav").css("top", $('.autoscale__div').height() - 70);
  $(".slider-nav").css("left", ($('.autoscale__div').width()-200) / 2);

  // Initialization of first image and dot, interval time
  $(".dot").first().addClass('active-dot');
  $(".slide-img").first().css("display","block");
  $(".slide-img").first().addClass('active-img');

  var speed = {{ settings.slider_home_rate }};
  var auto_slide = setInterval(next_pic, speed);

  $('.arrow-next').click(next_pic);
  $('.arrow-prev').click(prev_pic);
  $('.dot').click(change_pic);
  $('.slider-nav').hover(function(){
    clearInterval(auto_slide);
  }, function(){
    auto_slide = setInterval(next_pic, speed);
  });
}

window.onresize = autoscale_element;
$(document).ready(autoscale_element);
$(document).ready(shopping_cart);
$(document).ready(artist_page);
$(document).ready(carousel_setting);